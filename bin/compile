#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e            # fail fast
set -o pipefail   # don't ignore exit codes when piping output
# set -x          # enable debugging

# Configure directories
build_dir=$1
cache_dir=$2
env_dir=$3

bp_dir=$(cd $(dirname $0); cd ..; pwd)

# clean up leaking environment
unset GIT_DIR

# Load some convenience functions like status(), echo(), and indent()
source $bp_dir/bin/common.sh

source "$build_dir/_webassets.cfg"

# Temporary Directories ------------------------
RUBY_BUILD_DIR=$(mktemp -d -t ruby_build.XXXXXX)
GRUNT_BUILD_DIR=$(mktemp -d -t grunt_build.XXXXXX)

# mv $build_dir/* $TMP_BUILD_DIR

# Dependencies Installation --------------------
if [ -f $build_dir/grunt.js ] || [ -f $build_dir/Gruntfile.js ] || [ -f $build_dir/Gruntfile.coffee ]; then
  status "Using existing Gruntfile."
  if [ -f $build_dir/grunt-package.json ]; then
    status "Using existing grunt-package."
    mv $build_dir/grunt-package.json $GRUNT_BUILD_DIR/package.json
  elif [ -f $build_dir/package.json ]; then
    status "Using existing package."
    cp $build_dir/package.json $GRUNT_BUILD_DIR/package.json
  fi

  if [ -f $build_dir/grunt-Gemfile ]; then
    status "Using existing grunt-Gemfile."
    mv $build_dir/grunt-Gemfile $RUBY_BUILD_DIR/Gemfile
  elif [ -f $build_dir/Gemfile ]; then
    status "Using existing Gemfile."
    cp $build_dir/Gemfile $RUBY_BUILD_DIR/Gemfile
  fi

  if [ -f $build_dir/grunt-Gemfile.lock ]; then
    status "Using existing grunt-Gemfile.lock."
    mv $build_dir/grunt-Gemfile.lock $RUBY_BUILD_DIR/Gemfile.lock
  elif [ -f $build_dir/Gemfile.lock ]; then
    status "Using existing Gemfile.lock."
    cp $build_dir/Gemfile.lock $RUBY_BUILD_DIR/Gemfile.lock
  fi
else
  status "Using default Gruntfile."
  mv $bp_dir/vendor/Gruntfile.js $GRUNT_BUILD_DIR/
fi


if [ ! -f $GRUNT_BUILD_DIR/package.json ]; then
  status "Using default package."
  mv $bp_dir/vendor/package-webassets.json $GRUNT_BUILD_DIR/package.json
fi
if [ ! -f $RUBY_BUILD_DIR/Gemfile ]; then
  status "Using default Gemfile."
  mv $bp_dir/vendor/Gemfile $RUBY_BUILD_DIR/
fi
if [ ! -f $RUBY_BUILD_DIR/Gemfile.lock ]; then
  status "Using default Gemfile.lock."
  mv $bp_dir/vendor/Gemfile.lock $RUBY_BUILD_DIR/
fi

mkdir -p $cache_dir/webassets

# Ruby Installation --------------------------
status "Installing Ruby and gem dependencies..."
RUBY_BUILDPACK_DIR=$(mktemp -d -t ruby.XXXXXX)
git clone --quiet https://github.com/heroku/heroku-buildpack-ruby.git $RUBY_BUILDPACK_DIR
chmod -f +x $RUBY_BUILDPACK_DIR/bin/{detect,compile,release} || true
$RUBY_BUILDPACK_DIR/bin/compile $RUBY_BUILD_DIR $cache_dir/webassets
rm -fr $RUBY_BUILDPACK_DIR

# Node Installation --------------------------
status "Installing Node and build dependencies..."
NODE_BUILDPACK_DIR=$(mktemp -d -t node.XXXXXX)
git clone --quiet https://github.com/heroku/heroku-buildpack-nodejs.git $NODE_BUILDPACK_DIR
chmod -f +x $NODE_BUILDPACK_DIR/bin/{detect,compile,release} || true
$NODE_BUILDPACK_DIR/bin/compile $GRUNT_BUILD_DIR $cache_dir/webassets
rm -fr $NODE_BUILDPACK_DIR

status "Running Grunt Task heroku..."
curr_dir=$(pwd)
cd $GRUNT_BUILD_DIR
GEM_HOME=$RUBY_BUILD_DIR/vendor/bundle/ruby/2.1.0 \
GEM_PATH=$RUBY_BUILD_DIR/vendor/bundle/ruby/2.1.0:$GEM_PATH \
PATH=$GRUNT_BUILD_DIR/vendor/node/bin:$GRUNT_BUILD_DIR/bin:$GRUNT_BUILD_DIR/node_modules/.bin:$PATH \
PATH=$RUBY_BUILD_DIR/bin:$RUBY_BUILD_DIR/vendor/bundle/bin:$RUBY_BUILD_DIR/vendor/bundle/ruby/2.1.0/bin:$PATH \
grunt --base $build_dir heroku:$NODE_ENV | indent
cd $curr_dir

if [[ $USE_STATIC_SERVER ]] && [ -f $build_dir/_static.cfg ]; then
  # mv $TMP_BUILD_DIR/_static.cfg $build_dir
  status "Initializing Static Server..."
  STATIC_BUILDPACK_DIR=$(mktemp -d -t node.XXXXXX)
  git clone --quiet https://github.com/abhishekmunie/heroku-buildpack-static.git $STATIC_BUILDPACK_DIR
  chmod -f +x $STATIC_BUILDPACK_DIR/bin/{detect,compile,release} || true
  $STATIC_BUILDPACK_DIR/bin/compile $build_dir $cache_dir/webassets
  rm -fr $STATIC_BUILDPACK_DIR
fi

# Cleanup ------------------------------------
rm -fr $RUBY_BUILD_DIR
rm -fr $GRUNT_BUILD_DIR
